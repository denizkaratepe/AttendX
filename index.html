<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yaşar Üniversitesi Yoklama Sistemi</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;padding:20px}
    .container{max-width:600px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:30px;text-align:center}
    .content{padding:30px}
    .menu-buttons{display:flex;flex-direction:column;gap:15px;margin-bottom:30px}
    .menu-btn{padding:20px;border:2px solid #1e3c72;background:#fff;color:#1e3c72;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:.3s;display:flex;align-items:center;justify-content:center;gap:10px}
    .menu-btn:hover{background:#1e3c72;color:#fff;transform:translateY(-2px)}
    .section{display:none}
    .section.active{display:block;animation:fadeIn .3s}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;font-weight:600;color:#333}
    input,select,textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;transition:border .3s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#1e3c72}
    .btn{width:100%;padding:14px;background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:transform .2s}
    .btn:hover{transform:translateY(-2px)}
    .btn-secondary{background:#f5f5f5;color:#333;margin-top:10px}
    .btn-danger{background:linear-gradient(135deg,#f56565,#ed64a6)}
    .btn-success{background:linear-gradient(135deg,#48bb78,#38a169)}
    #qrcode{text-align:center;padding:30px;background:#f9f9f9;border-radius:10px;margin-top:20px}
    #qrcode canvas{border:3px solid #1e3c72;border-radius:10px;padding:10px;background:#fff}
    .info-box{background:#f0f4ff;border-left:4px solid #1e3c72;padding:15px;border-radius:5px;margin-top:20px}
    .timer{background:#ffe4e1;border-left:4px solid #ff6b6b;padding:15px;border-radius:5px;margin-top:20px;font-weight:600;color:#d63031}
    .student-list{max-height:300px;overflow-y:auto;border:2px solid #e0e0e0;border-radius:10px;padding:10px;margin-top:20px}
    .student-item{padding:10px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}
    .student-item:last-child{border-bottom:none}
    .student-count{background:#1e3c72;color:#fff;padding:5px 15px;border-radius:20px;font-weight:600;margin-top:10px;display:inline-block}
    .success-msg{background:#4caf50;color:#fff;padding:15px;border-radius:10px;margin-top:20px;text-align:center;font-weight:600}
    .error-msg{background:#f44336;color:#fff;padding:15px;border-radius:10px;margin-top:20px;text-align:center}
    .gps-status{padding:10px;border-radius:10px;margin-top:15px;text-align:center;font-weight:600}
    .gps-success{background:#e8f5e9;color:#2e7d32;border:2px solid #4caf50}
    .gps-error{background:#ffebee;color:#c62828;border:2px solid #f44336}
    .radio-group{display:flex;gap:20px;margin-top:10px}
    .radio-group label{display:flex;align-items:center;gap:5px;font-weight:normal}
    .back-btn{background:#6c757d;margin-bottom:20px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Yaşar Üniversitesi</h1>
      <p>Akıllı Yoklama Sistemi</p>
    </div>

    <div class="content">
      <!-- Ana menü -->
      <div id="main-menu" class="section active">
        <h2 style="text-align:center;margin-bottom:30px;color:#333;">Hoş Geldiniz</h2>
        <div class="menu-buttons">
          <button class="menu-btn" onclick="showSection('teacher-login')">Öğretim Üyesi Girişi</button>
          <button class="menu-btn" onclick="showSection('student-section')">Öğrenci Girişi</button>
          <button class="menu-btn" onclick="showSection('create-course')">Ders Oluştur</button>
        </div>
      </div>

      <!-- Ders oluştur -->
      <div id="create-course" class="section">
        <button class="btn back-btn" onclick="showSection('main-menu')">← Geri</button>
        <h2 style="margin-bottom:20px;color:#333;">Yeni Ders Oluştur</h2>

        <div class="form-group"><label>Ders Adı</label><input id="new-course-name" placeholder="örn: Bilgisayar Programlama"/></div>
        <div class="form-group"><label>Ders Kodu</label><input id="new-course-code" placeholder="örn: BIL101"/></div>
        <div class="form-group"><label>Öğretim Üyesi</label><input id="new-teacher-name" placeholder="örn: Prof. Dr. Ahmet Yılmaz"/></div>

        <div class="form-group">
          <label>Yoklama Tipi</label>
          <div class="radio-group">
            <label><input type="radio" name="attendance-type" value="weekly" checked/> Haftalık</label>
            <label><input type="radio" name="attendance-type" value="hourly"/> Saatlik</label>
          </div>
        </div>

        <div class="form-group"><label>Ders Şifresi</label><input type="password" id="new-course-password" placeholder="Güçlü bir şifre"/></div>
        <button class="btn btn-success" onclick="createCourse()">Dersi Oluştur</button>
        <div id="create-course-message"></div>
      </div>

      <!-- Öğretim üyesi girişi -->
      <div id="teacher-login" class="section">
        <button class="btn back-btn" onclick="showSection('main-menu')">← Geri</button>
        <h2 style="margin-bottom:20px;color:#333;">Öğretim Üyesi Girişi</h2>
        <div class="form-group"><label>Ders Kodu</label><input id="teacher-course-code" placeholder="örn: BIL101"/></div>
        <div class="form-group"><label>Şifre</label><input type="password" id="teacher-password" placeholder="Ders şifresi"/></div>
        <button class="btn" onclick="teacherLogin()">Giriş Yap</button>
        <div id="teacher-login-message"></div>
      </div>

      <!-- Öğretim üyesi paneli -->
      <div id="teacher-panel" class="section">
        <button class="btn back-btn" onclick="logout()">Çıkış</button>
        <h2 style="margin-bottom:20px;color:#333;">Yoklama Yönetimi</h2>
        <div class="info-box">
          <h3 id="course-info-display"></h3>
          <p id="teacher-info-display"></p>
        </div>
        <div class="form-group">
          <label>Hafta Seçin</label>
          <select id="week-select">
            <option value="">Hafta Seçin</option>
            <script>for(let i=1;i<=14;i++)document.write(`<option value="${i}">${i}. Hafta</option>`)</script>
          </select>
        </div>
        <button class="btn btn-success" onclick="startAttendance()">Yoklama Başlat</button>

        <div id="qr-display" style="display:none;">
          <div id="qrcode"></div>
          <div class="timer" id="timer"></div>
          <div class="student-list" id="student-list">
            <h3>Yoklama Giren Öğrenciler:</h3><div id="students"></div>
          </div>
          <span class="student-count" id="student-count">Toplam: 0 Öğrenci</span>
          <button class="btn btn-secondary" onclick="exportToSheets()">Google Sheets'te Gör</button>
          <button class="btn btn-danger" onclick="endAttendance()">Yoklamayı Bitir</button>
        </div>
      </div>

      <!-- Öğrenci -->
      <div id="student-section" class="section">
        <button class="btn back-btn" onclick="showSection('main-menu')">← Geri</button>
        <h2 style="margin-bottom:20px;color:#333;">Öğrenci Yoklama</h2>
        <div class="info-box"><p>QR kodu okut ya da ders kodunu gir.</p></div>

        <input type="hidden" id="student-att-type" value="weekly"/>

        <div class="form-group"><label>Ders Kodu</label><input id="student-course-code" placeholder="QR ile gelir veya yaz"/></div>
        <div class="form-group" id="week-group"><label>Hafta</label><input type="number" id="student-week" min="1" max="14" placeholder="1-14"/></div>
        <div class="form-group"><label>Öğrenci No</label><input id="student-number" placeholder="2021012345"/></div>
        <div class="form-group"><label>Ad Soyad</label><input id="student-name" placeholder="Ali Yılmaz"/></div>

        <div id="gps-status"></div>
        <button class="btn" onclick="submitAttendance()">Konumumu Kontrol Et ve Yoklama Gir</button>
        <div id="student-message"></div>
      </div>
    </div>
  </div>

  <script>
    // !!! BURAYI KENDİ WEB APP URL'İNLE DOLDUR !!!
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwFvPlmAzXwwjwx3wWf_dvIj4cp5k2wvdi-2V7LTV_-YSBwnraBTwjKbsg2N0TO5ufaWA/exec";

    let currentCourse = null;
    let timerInterval = null;
    let attendanceList = [];
    let pollId = null;

    // URL parametreleri (QR)
    window.onload = function () {
      const p = new URLSearchParams(window.location.search);
      const c = p.get("c");
      const t = p.get("t");         // weekly | hourly
      const w = p.get("w");         // weekly ise hafta

      if (c) {
        showSection("student-section");
        document.getElementById("student-course-code").value = c;
      }

      // attendance type
      if (t === "hourly") {
        document.getElementById("student-att-type").value = "hourly";
        document.getElementById("week-group").style.display = "none";
        document.getElementById("student-week").value = "";
      } else {
        document.getElementById("student-att-type").value = "weekly";
        document.getElementById("week-group").style.display = "block";
        if (w) document.getElementById("student-week").value = w;
      }
    };

    function showSection(id){
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // Ders oluştur
    async function createCourse(){
      const courseName = val("new-course-name");
      const courseCode = val("new-course-code");
      const teacherName = val("new-teacher-name");
      const attendanceType = document.querySelector('input[name="attendance-type"]:checked').value;
      const password = val("new-course-password");

      if(!courseName || !courseCode || !teacherName || !password)
        return showMessage("create-course-message","Lütfen tüm alanları doldur.","error");

      const res = await postJson({
        action:"createCourse", courseName, courseCode, teacherName, attendanceType, password
      });

      if(res.success){
        showMessage("create-course-message", `✅ ${courseCode} dersi oluşturuldu.`, "success");
        set(["new-course-name","new-course-code","new-teacher-name","new-course-password"], "");
        setTimeout(()=>showSection("main-menu"),1500);
      }else showMessage("create-course-message","Hata: "+res.error,"error");
    }

    // Hoca login
    async function teacherLogin(){
      const courseCode = val("teacher-course-code");
      const password   = val("teacher-password");
      if(!courseCode || !password) return showMessage("teacher-login-message","Boş alan var.","error");

      const res = await postJson({ action:"teacherLogin", courseCode, password });
      if(res.success){
        currentCourse = { code:courseCode, name:res.courseName, teacher:res.teacherName, attendanceType:res.attendanceType };
        byId("course-info-display").textContent = `${courseCode} - ${res.courseName}`;
        byId("teacher-info-display").textContent = `Öğretim Üyesi: ${res.teacherName} | Tip: ${res.attendanceType==='weekly'?'Haftalık':'Saatlik'}`;
        showSection("teacher-panel");
      } else showMessage("teacher-login-message","Hata: "+res.error,"error");
    }

    // Yoklama başlat
    function startAttendance(){
      if(!currentCourse) return;

      const week = byId("week-select").value;
      if(currentCourse.attendanceType==="weekly" && !week){ alert("Hafta seç."); return; }

      const base = window.location.href.split("?")[0];
      const qrData = (currentCourse.attendanceType==="hourly")
        ? `${base}?c=${currentCourse.code}&t=hourly`
        : `${base}?c=${currentCourse.code}&t=weekly&w=${week}`;

      byId("qrcode").innerHTML = "";
      new QRCode(byId("qrcode"), { text: qrData, width:250, height:250 });

      // 5 dk sayaç
      startTimer(Date.now()+5*60*1000);

      // liste temizle
      attendanceList = []; updateStudentList();
      byId("qr-display").style.display = "block";

      if(pollId) clearInterval(pollId);
      pollId = setInterval(()=>fetchAttendanceList(week || ""), 5000);
    }

    function startTimer(end){
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        const left = end - Date.now();
        if(left<=0){ clearInterval(timerInterval); byId("timer").textContent = "Süre doldu."; return; }
        const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
        byId("timer").textContent = `Kalan: ${m}:${String(s).padStart(2,"0")}`;
      },1000);
    }

    async function fetchAttendanceList(week){
      if(!currentCourse) return;
      const res = await postJson({
        action:"getAttendanceList",
        courseCode: currentCourse.code,
        attendanceType: currentCourse.attendanceType,
        week: week
      });
      if(res.success){ attendanceList = res.students || []; updateStudentList(); }
    }

    function updateStudentList(){
      const listDiv = byId("students");
      if(attendanceList.length===0) listDiv.innerHTML = '<p style="color:#666;">Henüz öğrenci yok...</p>';
      else listDiv.innerHTML = attendanceList.map(s=>(
        `<div class="student-item"><span><strong>${s.number||""}</strong> - ${s.name||""}</span><span style="color:green;">✓</span></div>`
      )).join("");
      byId("student-count").textContent = `Toplam: ${attendanceList.length} Öğrenci`;
    }

    // Öğrenci gönderimi
    async function submitAttendance(){
      const courseCode = val("student-course-code");
      const week = val("student-week");
      const studentNumber = val("student-number");
      const studentName = val("student-name");
      const attendanceType = val("student-att-type"); // weekly | hourly

      if(!courseCode || !studentNumber || !studentName)
        return showMessage("student-message","Boş alan var.","error");
      if(attendanceType==="weekly" && !week)
        return showMessage("student-message","Hafta numarası eksik.","error");

      if(!navigator.geolocation)
        return showMessage("student-message","Tarayıcın konum desteği vermiyor.","error");

      byId("gps-status").innerHTML = '<div class="gps-status" style="background:#fff3cd;color:#856404;">Konum alınıyor...</div>';

      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;

        const res = await postJson({
          action:"submitAttendance",
          courseCode, week, studentNumber, studentName, lat, lon, attendanceType
        });

        if(res.success){
          byId("gps-status").innerHTML = `<div class="gps-status gps-success">Kampüs içi ✓ (${res.distance}m)</div>`;
          showMessage("student-message","Yoklaman kaydedildi.","success");
          set(["student-number","student-name"], "");
        } else {
          byId("gps-status").innerHTML = `<div class="gps-status gps-error">${res.error||"Hata"}</div>`;
          showMessage("student-message","Yoklama kaydedilemedi.","error");
        }
      }, err=>{
        byId("gps-status").innerHTML = '<div class="gps-status gps-error">Konum alınamadı. İzin ver.</div>';
        showMessage("student-message","Konum hatası: "+err.message,"error");
      }, { enableHighAccuracy:true, timeout:10000 });
    }

    function endAttendance(){
      if(confirm("Yoklamayı bitireyim mi?")){
        if(timerInterval) clearInterval(timerInterval);
        if(pollId) clearInterval(pollId);
        byId("qr-display").style.display = "none";
        byId("week-select").value = "";
        attendanceList = [];
      }
    }

    function exportToSheets(){
      alert("Veriler Google Sheets'te. Sheets ID:\n\n1Kb9NJALEINY8oy3UpQsZCa1_8smfy-tWwn_jCuceJiw");
    }

    function logout(){
      currentCourse=null; showSection("main-menu");
      set(["teacher-course-code","teacher-password"], "");
    }

    // ===== yardımcılar =====
    async function postJson(obj){
      const r = await fetch(GAS_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(obj) });
      return r.json();
    }
    function byId(id){ return document.getElementById(id); }
    function val(id){ return byId(id).value.trim(); }
    function set(ids, v){ (Array.isArray(ids)?ids:[ids]).forEach(id=>byId(id).value=v); }
    function showMessage(elId, msg, type){
      const el = byId(elId); if(!el) return;
      el.className = (type==="error")? "error-msg" : "success-msg";
      el.textContent = msg; el.style.display = "block";
      setTimeout(()=> el.style.display="none", 4000);
    }
  </script>
</body>
</html>
