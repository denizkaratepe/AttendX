<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yaşar Üniversitesi Yoklama</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:#eef2f7;margin:0;padding:20px}
  .card{max-width:1100px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.1);overflow:hidden}
  header{background:#1e3c72;color:#fff;padding:20px}
  main{padding:20px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  input,select,button{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px}
  button{cursor:pointer;background:#1e3c72;color:#fff;border:none}
  button.secondary{background:#6b7280}
  .section{display:none}.section.active{display:block}
  .msg{margin-top:10px;padding:10px;border-radius:8px}
  .error{background:#fee2e2;color:#991b1b}.ok{background:#dcfce7;color:#166534}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;font-size:14px}
  th{background:#f3f4f6;position:sticky;top:0}
  .cell-ok{background:#e8f5e9} .cell-warn{background:#fff7cc} .cell-fail{background:#fde2e2}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600}
  .chip.ok{background:#16a34a22;color:#166534;border:1px solid #16a34a}
  .chip.warn{background:#f59e0b22;color:#92400e;border:1px solid #f59e0b}
  .chip.fail{background:#ef444422;color:#991b1b;border:1px solid #ef4444}
  .flex{display:flex;gap:12px;align-items:center}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<div class="card">
  <header><h2>Yaşar Üniversitesi — Akıllı Yoklama</h2></header>
  <main>

    <!-- Menü -->
    <div id="menu" class="section active">
      <div class="row">
        <div class="col">
          <h3>Ders Oluştur</h3>
          <input id="c-name" placeholder="Ders adı (BIL101)"><br><br>
          <input id="c-code" placeholder="Ders kodu (BIL101)"><br><br>
          <input id="c-teacher" placeholder="Öğretim üyesi"><br><br>
          <div class="row">
            <div class="col">
              <select id="c-type">
                <option value="weekly">Haftalık (14 hafta)</option>
                <option value="hourly">Saatlik</option>
              </select>
            </div>
            <div class="col">
              <select id="c-req">
                <option value="70">Devam şartı %70</option>
                <option value="75">Devam şartı %75</option>
                <option value="80">Devam şartı %80</option>
                <option value="85">Devam şartı %85</option>
                <option value="90">Devam şartı %90</option>
              </select>
            </div>
          </div><br>
          <input id="c-pass" placeholder="Ders şifresi (hoca)" type="password"><br><br>
          <button onclick="createCourse()">Dersi Oluştur</button>
          <div id="msg-create" class="msg" style="display:none"></div>
        </div>

        <div class="col">
          <h3>Öğretim Üyesi Giriş</h3>
          <input id="t-code" placeholder="Ders kodu"><br><br>
          <input id="t-pass" placeholder="Şifre" type="password"><br><br>
          <button onclick="teacherLogin()">Giriş Yap</button>
          <div id="msg-login" class="msg" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- Hoca paneli -->
    <div id="panel" class="section">
      <div class="flex">
        <button class="secondary" onclick="logout()">← Çıkış</button>
        <h3 id="courseTitle"></h3>
        <span id="ruleChip" class="chip"></span>
      </div>
      <br>

      <div class="row">
        <div class="col">
          <label>Hafta seç</label>
          <select id="week">
            <option value="">(seç)</option>
            <script>for(let i=1;i<=14;i++)document.write(`<option value="${i}">${i}. Hafta</option>`)</script>
          </select>
        </div>

        <!-- Konum zorunlu anahtarı -->
        <div class="col">
          <label style="display:block;">Konum zorunlu</label>
          <label style="display:inline-flex;align-items:center;gap:8px;">
            <input id="geo-required" type="checkbox" checked />
            <span>Etkin</span>
          </label>
        </div>

        <div class="col">
          <button onclick="startAttendance()">QR ile Yoklama Başlat</button>
        </div>
      </div>

      <div id="qrWrap" style="display:none;margin-top:10px">
        <div id="qrcode"></div>
        <div id="timer" class="msg"></div>
      </div>

      <h4 style="margin-top:16px">Öğrenci Listesi (Canlı)</h4>
      <div id="listMsg" class="msg" style="display:none"></div>
      <div style="overflow:auto;max-height:60vh">
        <table id="grid"></table>
      </div>
    </div>

    <!-- Öğrenci -->
    <div id="student" class="section">
      <h3>Öğrenci Yoklama</h3>
      <input id="s-course" placeholder="Ders kodu"><br><br>
      <div id="weekBox">
        <input id="s-week" type="number" min="1" max="14" placeholder="Hafta (1-14)"><br><br>
      </div>
      <input id="s-no" placeholder="Öğrenci No"><br><br>
      <input id="s-name" placeholder="Ad Soyad"><br><br>
      <button onclick="submitAttendance()">Konumumu Kontrol Et ve Kaydet</button>
      <div id="msg-stu" class="msg" style="display:none"></div>
    </div>

  </main>
</div>

<script>
  // KENDİ /exec URL'İN
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxiH_FJKFjaZMwaH3FY0xOD0Kx2Srle8uy5ARuDZ88N3EkEEuZ2p3ATDJO87F2zxj8uLw/exec";

  let current = null; // {code,name,teacher,attendanceType,requiredPct}
  let poll = null, tick = null;

  // QR parametreleri → öğrenci formu
  (function(){
    const p = new URLSearchParams(location.search);
    const c = p.get('c'), t = p.get('t'), w = p.get('w'), geo = p.get('geo');
    if (c) { show('student'); byId('s-course').value = c; }
    if (t === 'hourly') { byId('weekBox').style.display='none'; byId('s-week').value=''; }
    else if (w) { byId('s-week').value = w; }
    window._geoRequired = (geo !== '0'); // default true
  })();

  // ===== helpers =====
  function byId(x){return document.getElementById(x)}
  function show(id){['menu','panel','student'].forEach(s=>byId(s).classList.remove('active')); byId(id).classList.add('active')}
  function msg(id, text, ok){const el=byId(id); el.textContent=text; el.className='msg '+(ok?'ok':'error'); el.style.display='block';}
  async function call(obj){
    // CORS PRE-FLIGHT YOK: text/plain gönderiyoruz
    const r = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(obj)});
    return r.json();
  }

  // ===== Create Course =====
  async function createCourse(){
    const res = await call({
      action:'createCourse',
      courseName: byId('c-name').value.trim(),
      courseCode: byId('c-code').value.trim(),
      teacherName: byId('c-teacher').value.trim(),
      attendanceType: byId('c-type').value,
      requiredPct: byId('c-req').value,
      password: byId('c-pass').value
    }).catch(err=>({success:false,error:String(err)}));
    if (res.success) msg('msg-create','Ders oluşturuldu',true);
    else msg('msg-create','Hata: '+(res.error||'bilinmeyen'),false);
  }

  // ===== Teacher Login =====
  async function teacherLogin(){
    const res = await call({ action:'teacherLogin', courseCode: byId('t-code').value.trim(), password: byId('t-pass').value })
      .catch(err=>({success:false,error:String(err)}));
    if (!res.success) return msg('msg-login','Hata: '+(res.error||'giriş başarısız'),false);
    current = { code: byId('t-code').value.trim(), name: res.courseName, teacher: res.teacherName, attendanceType: res.attendanceType, requiredPct: res.requiredPct };
    byId('courseTitle').textContent = `${current.code} — ${current.name} (${current.attendanceType==='weekly'?'Haftalık':'Saatlik'})`;
    const chip = byId('ruleChip'); chip.textContent = `Devam şartı %${current.requiredPct}`; chip.className = 'chip ok';
    buildHeader();
    refreshTable();
    show('panel');
  }

  function logout(){ current=null; clearInterval(poll); clearInterval(tick); show('menu'); }

  // ===== Table header =====
  function buildHeader(){
    const g = byId('grid'); g.innerHTML='';
    const tr = document.createElement('tr');
    ['Öğrenci No','Ad Soyad'].forEach(h=>{const th=document.createElement('th'); th.textContent=h; tr.appendChild(th);});
    if (current.attendanceType==='weekly'){
      for(let i=1;i<=14;i++){ const th=document.createElement('th'); th.textContent='H'+i; tr.appendChild(th); }
      ['Devam%','Durum'].forEach(h=>{const th=document.createElement('th'); th.textContent=h; tr.appendChild(th);});
    }
    g.appendChild(tr);
  }

  // ===== Fetch + render table =====
  async function refreshTable(){
    if (!current) return;
    if (current.attendanceType!=='weekly'){ byId('listMsg').style.display='block'; byId('listMsg').textContent='Saatlik modda tablo yok.'; return; }

    const res = await call({ action:'getCourseTable', courseCode: current.code }).catch(()=>({success:false}));
    if (!res.success) { byId('listMsg').style.display='block'; byId('listMsg').textContent='Tablo alınamadı'; return; }
    byId('listMsg').style.display='none';

    const g = byId('grid');
    while (g.rows.length>1) g.deleteRow(1);

    res.table.forEach(row=>{
      const tr = document.createElement('tr');
      add(td(row.number)); add(td(row.name));
      row.weeks.forEach(w=> add(td(w==='✓'?'✓':'')));
      const p = row.percent, st = row.status;
      const pctTd = td(p+'%'); pctTd.className = st==='OK'?'cell-ok':(st==='WARN'?'cell-warn':'cell-fail'); add(pctTd);
      const stTd = td(st==='OK'?'Uygun':(st==='WARN'?'Sınırda':'Kaldı')); stTd.className=pctTd.className; add(stTd);
      g.appendChild(tr);
      function add(x){ tr.appendChild(x) }
      function td(t){ const el=document.createElement('td'); el.textContent=t||''; return el; }
    });
  }

  // ===== Start attendance + QR =====
  function startAttendance(){
    if (!current) return;
    if (current.attendanceType==='weekly' && !byId('week').value){ alert('Hafta seç'); return; }

    const base = location.href.split('?')[0];
    const geo = byId('geo-required').checked ? '1' : '0';
    const qrData = current.attendanceType==='hourly'
      ? `${base}?c=${current.code}&t=hourly&geo=${geo}`
      : `${base}?c=${current.code}&t=weekly&w=${byId('week').value}&geo=${geo}`;

    byId('qrcode').innerHTML='';
    new QRCode(byId('qrcode'), { text: qrData, width:220, height:220 });
    byId('qrWrap').style.display='block';

    let end = Date.now()+5*60*1000;
    clearInterval(tick);
    tick=setInterval(()=>{
      const left=end-Date.now(); if (left<=0){ byId('timer').textContent='Süre doldu'; clearInterval(tick); return; }
      const m=Math.floor(left/60000), s=Math.floor((left%60000)/1000);
      byId('timer').textContent=`Kalan: ${m}:${String(s).padStart(2,'0')}`;
    },1000);

    clearInterval(poll);
    poll=setInterval(refreshTable, 5000);
  }

  // ===== Student submit =====
  async function submitAttendance(){
    const c = byId('s-course').value.trim();
    const w = byId('s-week').value.trim();
    const no = byId('s-no').value.trim();
    const nm = byId('s-name').value.trim();
    if (!c || !no || !nm) return msg('msg-stu','Boş alan var',false);

    // GPS kapalıysa direkt
    if (window._geoRequired === false) {
      const res = await call({ action:'submitAttendance', courseCode:c, week:w, studentNumber:no, studentName:nm, geoRequired:false });
      if (res.success){ msg('msg-stu','(GPS kapalı) Yoklama kaydedildi',true); byId('s-no').value=''; byId('s-name').value=''; }
      else msg('msg-stu','Hata: '+(res.error||'kayıt başarısız'),false);
      return;
    }

    if (!navigator.geolocation) return msg('msg-stu','Tarayıcın konum desteği vermiyor',false);
    msg('msg-stu','Konum alınıyor...',true);

    navigator.geolocation.getCurrentPosition(async pos=>{
      const res = await call({
        action:'submitAttendance',
        courseCode:c, week:w, studentNumber:no, studentName:nm,
        lat:pos.coords.latitude, lon:pos.coords.longitude, geoRequired:true
      });
      if (res.success){ msg('msg-stu','Yoklama kaydedildi ('+res.distance+'m)',true); byId('s-no').value=''; byId('s-name').value=''; }
      else msg('msg-stu','Hata: '+(res.error||'kayıt başarısız'),false);
    }, err=> msg('msg-stu','Konum hatası: '+err.message,false), {enableHighAccuracy:true, timeout:10000});
  }
</script>
</body>
</html>
